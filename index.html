<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6amMart Product Catalog & Cart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0fdf4; }
        .app-card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 900px; /* Increased width for two-column layout */
            width: 95%;
            transition: all 0.3s ease-in-out;
        }
        .green-btn {
            background-color: #10B981; /* Emerald 500 */
            transition: background-color 0.2s;
        }
        .green-btn:hover {
            background-color: #059669; /* Emerald 600 */
        }
        .input-field {
            border: 2px solid #D1FAE5; /* Emerald 100 border */
            background-color: #F0FDF4; /* Emerald 50 background */
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: #10B981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
        }
        .loader {
            border-top-color: #10B981;
            border-left-color: #10B981;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="app-card bg-white p-6 sm:p-8 rounded-2xl">
        <h1 class="text-3xl font-bold text-center mb-2 text-green-700">6amMart Marketplace</h1>
        
        <!-- Status Box for Errors/Success -->
        <div id="message-box" class="mt-4 p-3 rounded-lg text-sm font-medium transition duration-300 hidden"></div>

        <!-- App Container (Auth or Dashboard) -->
        <div id="app-container">
            <!-- Content will be injected here by JavaScript -->
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, doc, setDoc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Core Setup ---
        setLogLevel('debug');

        // Global Variable Fallback (Using your provided config)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        
        let firebaseConfig;
        if (firebaseConfigString) {
            try {
                firebaseConfig = JSON.parse(firebaseConfigString);
            } catch (e) {
                console.error("Error parsing __firebase_config:", e);
                displayMessage("Configuration Error: Invalid Firebase Config format.", 'error');
                throw new Error("Invalid Firebase Config.");
            }
        } else {
            // Hardcoded fallback config from user prompt (for editor use)
            firebaseConfig = {
                apiKey: "AIzaSyDm35wM7oGq06MEc7rsd9ZrCijbtUAZWNY",
                authDomain: "am-mart-database.firebaseapp.com",
                projectId: "am-mart-database",
                storageBucket: "am-mart-database.firebasestorage.app",
                messagingSenderId: "453648131188",
                appId: "1:453648131188:web:27e8cb59e5b47c0e11dd21",
                measurementId: "G-GRH69XMND7"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let isAuthReady = false;
        let products = []; // Public product catalog
        let cartItems = []; // Private user shopping cart
        let currentView = 'login'; 
        let productListenerInitialized = false; 
        const appContainer = document.getElementById('app-container');
        const messageBox = document.getElementById('message-box');

        // --- Paths & Collections ---
        const PUBLIC_PRODUCTS_PATH = `artifacts/${appId}/public/data/products`;

        /** Returns the Firestore Collection Reference for Products */
        function getProductsCollectionRef() {
            return collection(db, PUBLIC_PRODUCTS_PATH);
        }
        
        /** Returns the Firestore Collection Reference for the User's Cart */
        function getCartCollectionRef(userId) {
            // Private Collection: /artifacts/{appId}/users/{userId}/cartItems
            return collection(db, `artifacts/${appId}/users/${userId}/cartItems`);
        }

        // --- Utility Functions ---

        /** Displays messages in the dedicated message box. */
        function displayMessage(message, type = 'info', duration = 4000) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-200', 'text-red-800', 'bg-green-200', 'text-green-800', 'bg-gray-200', 'text-gray-800');
            
            if (type === 'error') {
                messageBox.classList.add('bg-red-200', 'text-red-800');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-200', 'text-green-800');
            } else {
                messageBox.classList.add('bg-gray-200', 'text-gray-800');
            }

            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, duration);
        }

        /** Toggles the loading state for the button. */
        function toggleLoading(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            if (!button) return;

            button.disabled = isLoading;
            button.innerHTML = isLoading 
                ? `<svg class="loader inline w-4 h-4 mr-3 border-2 border-transparent rounded-full" viewBox="0 0 24 24"></svg> Loading...`
                : button.getAttribute('data-text');
        }

        // --- Firestore Data Handlers ---

        let cartUnsubscribe = null; // To store the cart listener unsubscriber

        /** Sets up real-time listening for the logged-in user's cart. */
        function setupCartListener(userId) {
            if (cartUnsubscribe) {
                cartUnsubscribe(); // Unsubscribe previous listener if exists
            }
            if (!userId || !auth.currentUser || auth.currentUser.isAnonymous) {
                cartItems = [];
                renderDashboard(auth.currentUser); 
                return;
            }
            
            const cartRef = getCartCollectionRef(userId);

            cartUnsubscribe = onSnapshot(cartRef, (snapshot) => {
                const fetchedItems = [];
                snapshot.forEach(doc => {
                    fetchedItems.push({ id: doc.id, ...doc.data() });
                });
                cartItems = fetchedItems;
                console.log(`Fetched ${cartItems.length} items in cart.`);
                
                // Re-render the dashboard if it's the current view
                if (currentView === 'dashboard') {
                    renderDashboard(auth.currentUser);
                }
            }, (error) => {
                console.error("Cart Listener Error:", error);
                // The cart is private, so permissions are expected to work for logged-in users.
                if (auth.currentUser && !auth.currentUser.isAnonymous) {
                    displayMessage(`Error fetching cart: ${error.message}`, 'error', 10000);
                }
            });
        }

        /** Handles real-time listening for the public product catalog. */
        function setupProductListener() {
            const productsRef = getProductsCollectionRef();

            onSnapshot(productsRef, (snapshot) => {
                const fetchedProducts = [];
                snapshot.forEach(doc => {
                    fetchedProducts.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by name A-Z
                products = fetchedProducts.sort((a, b) => (a.name || "").localeCompare(b.name || ""));

                console.log(`Fetched ${products.length} products in real-time.`);
                
                // Re-render the dashboard if it's the current view
                if (currentView === 'dashboard') {
                    renderDashboard(auth.currentUser);
                }
            }, (error) => {
                // This is the error handler for the public catalog read.
                console.error("Product Listener Error:", error);
                displayMessage(`Error fetching catalog: **${error.message}**. Please ensure Firebase Security Rules allow 'read' access for public data (e.g., if request.auth != null)`, 'error', 10000);
            });
        }
        
        /** Seeds the public product catalog with initial data. */
        async function handleSeedCatalog() {
            const user = auth.currentUser;
            if (!user || user.isAnonymous) {
                displayMessage("Please log in to seed the catalog.", 'error');
                return;
            }

            const initialProducts = [
                { name: "Organic Apple", price: 0.99 },
                { name: "Fresh Milk (Gallon)", price: 4.50 },
                { name: "Whole Wheat Bread", price: 2.75 },
                { name: "Detergent Pods (20ct)", price: 12.00 },
                { name: "Paper Towels (6 Rolls)", price: 8.99 }
            ];

            const batch = writeBatch(db);
            const productsRef = getProductsCollectionRef();
            const addedBy = user.email || user.uid;

            initialProducts.forEach(product => {
                // Since we don't have existing document IDs, use addDoc logic which generates new ones
                const newDocRef = doc(productsRef); // Generate a new document reference with an auto ID
                batch.set(newDocRef, {
                    ...product,
                    addedBy: addedBy,
                    createdAt: new Date(),
                });
            });

            toggleLoading('seed-btn', true);

            try {
                await batch.commit();
                displayMessage(`Successfully added ${initialProducts.length} initial products!`, 'success');
            } catch (error) {
                console.error("Failed to seed catalog:", error);
                displayMessage(`Failed to seed catalog: ${error.message}`, 'error');
            } finally {
                toggleLoading('seed-btn', false);
            }
        }


        /** Adds a product to the user's private shopping cart, incrementing quantity if it exists. */
        async function handleAddToCart(productId, name, price) {
            const user = auth.currentUser;
            if (!user || user.isAnonymous) {
                displayMessage("Please log in to add items to your cart.", '
