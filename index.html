import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { 
    getAuth, 
    signInAnonymously, 
    signInWithCustomToken, 
    onAuthStateChanged, 
    signOut,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword
} from 'firebase/auth';
import { 
    getFirestore, 
    doc, 
    setDoc, 
    deleteDoc, 
    onSnapshot, 
    collection, 
    query, 
    writeBatch,
    getDoc,
    serverTimestamp,
    where
} from 'firebase/firestore';
import { setLogLevel } from 'firebase/firestore';

// Set Firebase logging level to Debug for visibility
setLogLevel('debug');

// --- Environment Variable Initialization ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// --- Mock Data for Seeding ---
const SEED_CATEGORIES = [
    { id: 'all', name: 'All', icon: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15H9v-4H5v-2h4V7h2v4h4v2h-4v4z' },
    { id: 'vegetables', name: 'Vegetables', icon: 'M12 2c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zM2 18h20v2H2z' },
    { id: 'fruits', name: 'Fruits', icon: 'M12 2c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zM2 18h20v2H2z' },
    { id: 'restaurants', name: 'Restaurants', icon: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z' },
    { id: 'meat', name: 'Meat', icon: 'M12 2c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zM2 18h20v2H2z' },
    { id: 'beverages', name: 'Beverages', icon: 'M12 2c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zM2 18h20v2H2z' },
    { id: 'grocery', name: 'Grocery', icon: 'M12 2c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zM2 18h20v2H2z' },
    { id: 'parcel', name: 'Parcel', icon: 'M12 2c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zM2 18h20v2H2z' },
];

const SEED_STORES = [
    { id: "green-leaf", name: "Green Leaf Vegetables", category: "vegetables", rating: 4.8, minTime: "20-30 min", maxTime: "20-30 min", deliveryFee: 2.99, tags: ["vegetables", "healthy"] },
    { id: "fruit-paradise", name: "Fruit Paradise", category: "fruits", rating: 4.5, minTime: "15-25 min", maxTime: "15-25 min", deliveryFee: 1.99, tags: ["fruits", "fresh"] },
    { id: "tasty-bites", name: "Tasty Bites Restaurant", category: "restaurants", rating: 4.0, minTime: "30-40 min", maxTime: "30-40 min", deliveryFee: 3.99, tags: ["restaurants", "fastfood"] },
    { id: "premium-meat", name: "Premium Meat Market", category: "meat", rating: 4.5, minTime: "24-35 min", maxTime: "24-35 min", deliveryFee: 2.49, tags: ["meat", "butcher"] },
    { id: "beverage-hub", name: "Beverage Hub", category: "beverages", rating: 4.4, minTime: "20-30 min", maxTime: "20-30 min", deliveryFee: 1.49, tags: ["beverages", "drinks"] },
    { id: "daily-essentials", name: "Daily Essentials Store", category: "grocery", rating: 4.2, minTime: "20-30 min", maxTime: "20-30 min", deliveryFee: 2.99, tags: ["grocery", "convenience"] },
    { id: "quick-parcel", name: "Quick Parcel Service", category: "parcel", rating: 4.2, minTime: "30-60 min", maxTime: "30-60 min", deliveryFee: 5.99, tags: ["parcel", "delivery"] },
];

const App = () => {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [authEmail, setAuthEmail] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    
    // App State
    const [stores, setStores] = useState([]);
    const [message, setMessage] = useState('');
    const [isAdmin, setIsAdmin] = useState(false);
    const [selectedCategory, setSelectedCategory] = useState('all'); // State for category filter
    const [searchTerm, setSearchTerm] = useState('');

    // --- Firebase Initialization and Auth ---
    useEffect(() => {
        if (!Object.keys(firebaseConfig).length) {
            setMessage("Error: Firebase configuration is missing.");
            return;
        }

        try {
            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
            const firebaseAuth = getAuth(app);
            setDb(firestore);
            setAuth(firebaseAuth);

            const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
                if (user) {
                    setUserId(user.uid);
                    setAuthEmail(user.isAnonymous ? 'Guest User' : user.email);
                    
                    if (firestore) {
                        try {
                            // Check or create the Admin Config document
                            const adminConfigRef = doc(firestore, `artifacts/${appId}/config/admin`);
                            const adminConfigSnap = await getDoc(adminConfigRef);
                            
                            if (!adminConfigSnap.exists()) {
                                // If admin config doesn't exist, create it. This will only happen once.
                                await setDoc(adminConfigRef, { 
                                    userId: user.uid, 
                                    createdAt: serverTimestamp() 
                                });
                                setIsAdmin(true);
                            } else {
                                setIsAdmin(adminConfigSnap.data().userId === user.uid);
                            }
                        } catch (error) {
                            // This is the error the user reported. It's security rule related.
                            console.error("Admin check/creation failed:", error);
                            setIsAdmin(false);
                        }
                    } 
                } else {
                    setUserId(null);
                    setAuthEmail(null);
                    setIsAdmin(false);
                }
                setIsAuthReady(true);
            });
            
            // Initial sign-in attempt
            (async () => {
                if (!firebaseAuth.currentUser) {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(firebaseAuth, initialAuthToken);
                        } else {
                            await signInAnonymously(firebaseAuth);
                        }
                    } catch (error) {
                        console.error("Initial sign-in failed:", error);
                    }
                }
            })();

            return () => unsubscribe();
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            setMessage(`Initialization Failed: ${error.message}`);
        }
    }, [initialAuthToken]);


    // --- Firestore Listeners (Store Catalog) ---

    // 1. Listen for Store Catalog Changes (Public Data)
    useEffect(() => {
        if (!db || !isAuthReady || !userId) return; 

        const storesColRef = collection(db, `artifacts/${appId}/public/data/stores`);
        // Note: For large collections, firestore does not support text search.
        // We fetch all and filter locally for this small demo.
        const q = query(storesColRef); 
        let unsubscribe = () => {};

        try {
            unsubscribe = onSnapshot(q, (snapshot) => {
                const fetchedStores = snapshot.docs.map(d => ({
                    id: d.id,
                    ...d.data()
                }));
                setStores(fetchedStores);
            }, (error) => {
                console.error("Error loading stores:", error);
                setMessage("Error loading stores. Check Firestore Security Rules for public/data/stores.");
                setStores([]);
            });
        } catch (e) {
            console.error("Store Listener setup failed:", e);
        }

        return () => unsubscribe();
    }, [db, isAuthReady, userId]);

    // --- Store & Category Handlers ---

    const handleSeedCatalog = async () => {
        if (!db || !isAdmin) {
            setMessage("Seeding Failed: Only the authorized user can seed the catalog.");
            return;
        }

        const batch = writeBatch(db);
        const storesColRef = collection(db, `artifacts/${appId}/public/data/stores`);
        
        try {
            // Clear existing stores first (simple cleanup for demo)
            stores.forEach(store => {
                const docRef = doc(storesColRef, store.id);
                batch.delete(docRef);
            });

            // Add new seed stores
            SEED_STORES.forEach(store => {
                const docRef = doc(storesColRef, store.id);
                batch.set(docRef, store);
            });

            await batch.commit();
            setMessage('Store catalog seeded successfully!');
        } catch (error) {
            console.error('Seeding Failed:', error);
            setMessage(`Seeding Failed: ${error.message}. Check your Firestore Rules for public/data/stores (write access for admin).`);
        }
    };
    
    // --- Filtering Logic ---
    const filteredStores = useMemo(() => {
        let currentStores = stores;

        // 1. Filter by Category
        if (selectedCategory !== 'all') {
            currentStores = currentStores.filter(store => 
                store.category === selectedCategory
            );
        }

        // 2. Filter by Search Term (Search name or tags)
        if (searchTerm) {
            const lowerSearchTerm = searchTerm.toLowerCase();
            currentStores = currentStores.filter(store => 
                store.name.toLowerCase().includes(lowerSearchTerm) || 
                store.tags?.some(tag => tag.toLowerCase().includes(lowerSearchTerm))
            );
        }

        return currentStores;
    }, [stores, selectedCategory, searchTerm]);

    // --- Components & UI Helpers ---

    // SVG icon helper (replaces lucid icon usage)
    const LucideIcon = ({ pathData, className = "w-5 h-5" }) => (
        <svg 
            xmlns="http://www.w3.org/2000/svg" 
            viewBox="0 0 24 24" 
            fill="currentColor" 
            className={className}
        >
            <path d={pathData} />
        </svg>
    );

    const CategoryPill = ({ category }) => {
        const isActive = selectedCategory === category.id;
        return (
            <button
                key={category.id}
                onClick={() => setSelectedCategory(category.id)}
                className={`flex flex-col items-center justify-center p-3 rounded-xl transition-all w-[90px] h-[90px] shadow-sm 
                    ${isActive 
                        ? 'bg-green-600 text-white shadow-lg' 
                        : 'bg-white text-gray-700 hover:bg-gray-100'
                    }`}
            >
                <LucideIcon pathData={category.icon} className={`w-6 h-6 mb-1 ${isActive ? 'text-white' : 'text-green-600'}`} />
                <span className={`text-sm font-medium ${isActive ? 'text-white' : 'text-gray-700'}`}>
                    {category.name}
                </span>
            </button>
        );
    };

    const StoreCard = ({ store }) => (
        <div className="bg-white p-4 rounded-xl shadow-md flex flex-col space-y-2 border border-gray-100 hover:shadow-lg transition-shadow">
            <h3 className="text-xl font-semibold text-gray-800">{store.name}</h3>
            
            {/* Tags and Rating */}
            <div className="flex items-center space-x-2 text-sm">
                <div className="flex space-x-1">
                    {store.tags.map(tag => (
                        <span key={tag} className="px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full capitalize">
                            {tag}
                        </span>
                    ))}
                </div>
                <div className="flex items-center text-yellow-500 font-medium">
                    <LucideIcon pathData="M12 2l3.09 6.36L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14l-5-4.87 6.91-1.01L12 2z" className="w-4 h-4 mr-1" />
                    {store.rating.toFixed(1)}
                </div>
            </div>

            {/* Details (Time/Delivery) */}
            <div className="flex items-center justify-between text-sm text-gray-600 border-t border-gray-50 pt-2">
                <div className="flex items-center">
                    <LucideIcon pathData="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z" className="w-4 h-4 mr-1 text-green-500" />
                    {store.minTime} delivery
                </div>
                <div className="font-semibold text-green-700">
                    ${store.deliveryFee.toFixed(2)} delivery
                </div>
            </div>

            {/* This button would link to the store detail page in a full app */}
            <button 
                className="mt-3 w-full p-2 bg-green-500 text-white font-medium rounded-lg hover:bg-green-600 transition-colors"
                onClick={() => setMessage(`Navigating to ${store.name}...`)}
            >
                View Store
            </button>
        </div>
    );

    // --- Main Render ---
    return (
        <div className="min-h-screen bg-gray-50 p-4 md:p-6 font-sans flex justify-center">
            <div className="w-full max-w-xl bg-white rounded-t-3xl shadow-2xl relative">
                {/* Header (fixed to simulate mobile app) */}
                <div className="sticky top-0 bg-white p-4 pb-3 z-10 border-b border-gray-100 rounded-t-3xl">
                    <div className="flex justify-between items-center mb-4">
                        <div className="flex items-center text-gray-800">
                            <LucideIcon pathData="M12 2L2 7v10l10 5 10-5V7L12 2zm0 15.93l-6-3V8.07l6 3v4.86zm0-10.86L6 5.17l6 3 6-3-6-3.07z" className="w-6 h-6 text-green-600 mr-2" />
                            <span className="text-sm font-medium">76a eighth avenue, New York, US</span>
                        </div>
                        {/* Cart Icon */}
                        <div className="relative">
                            <LucideIcon pathData="M17 18a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-1-3h14l-3.25-7H7l-1.5 5zm-2.5 0H4l-1.5-5H7z" className="w-6 h-6 text-gray-700 cursor-pointer" />
                            {/* In a full app, this would show item count */}
                        </div>
                    </div>
                    
                    {/* Search Bar */}
                    <div className="relative">
                        <input
                            type="text"
                            placeholder="Search for stores or items here..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full p-3 pl-10 border border-gray-200 rounded-xl bg-gray-50 focus:ring-green-500 focus:border-green-500 transition-shadow"
                        />
                        <LucideIcon pathData="M19 11A8 8 0 1 0 5 11a8 8 0 0 0 14 0zm-2 0a6 6 0 1 1-12 0 6 6 0 0 1 12 0zm-2 7.71l3.71 3.71-1.42 1.42-3.71-3.71z" className="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
                    </div>
                </div>

                {/* Content Area */}
                <div className="p-4 space-y-6">

                    {/* Authentication Status / Admin Control */}
                    <div className="p-3 bg-gray-100 rounded-xl flex justify-between items-center text-sm text-gray-700">
                        {isAuthReady ? (
                            <span className="font-medium text-green-700">Logged in: {authEmail}</span>
                        ) : (
                            <span className="font-medium text-yellow-600">Loading Authentication...</span>
                        )}
                        {isAdmin && (
                            <button
                                onClick={handleSeedCatalog}
                                className="px-3 py-1 bg-yellow-500 text-white font-medium rounded-full text-xs hover:bg-yellow-600 transition-colors"
                            >
                                Seed Catalog
                            </button>
                        )}
                    </div>
                    
                    {message && (
                        <div className={`p-3 rounded-lg text-sm font-medium ${message.includes('success') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                            {message}
                        </div>
                    )}

                    {/* Banner (Mocked) */}
                    <div className="bg-gradient-to-r from-green-500 to-green-400 p-6 rounded-2xl shadow-lg relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-24 h-24 bg-white opacity-10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
                        <h2 className="text-2xl font-bold text-white mb-1">Healthy Food</h2>
                        <p className="text-white text-sm">50% Flat Discount</p>
                        <button className="mt-3 text-white text-sm font-semibold hover:text-green-900 transition-colors flex items-center">
                            See All
                            <LucideIcon pathData="M5 12h14M12 5l7 7-7 7" className="w-4 h-4 ml-1" />
                        </button>
                    </div>

                    {/* Categories Section */}
                    <h2 className="text-xl font-semibold text-gray-800 mb-3">Categories</h2>
                    <div className="flex space-x-3 overflow-x-scroll pb-2 scrollbar-hide">
                        {SEED_CATEGORIES.map(category => (
                            <CategoryPill key={category.id} category={category} />
                        ))}
                    </div>

                    {/* Stores Section */}
                    <h2 className="text-xl font-semibold text-gray-800 mb-3">
                        All Stores 
                        {(selectedCategory !== 'all' || searchTerm) && (
                            <span className="text-sm font-normal text-gray-500 ml-2">({filteredStores.length} results)</span>
                        )}
                    </h2>
                    
                    <div className="space-y-4">
                        {filteredStores.length === 0 ? (
                            <p className="text-center text-gray-500 py-6">
                                No stores found matching your criteria.
                            </p>
                        ) : (
                            filteredStores.map(store => (
                                <StoreCard key={store.id} store={store} />
                            ))
                        )}
                    </div>
                </div>
                
                {/* Auth/Debug info for visibility */}
                <div className="p-4 bg-gray-100 mt-6 rounded-b-3xl">
                    <p className="text-xs text-gray-500 break-words">
                        **USER ID**: {userId || 'N/A'}
                    </p>
                    <p className="text-xs text-gray-500">
                        **ADMIN**: {isAdmin ? 'Yes' : 'No'}
                    </p>
                </div>

            </div>
        </div>
    );
};

export default App;
