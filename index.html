<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6amMart User App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Light green background */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }
        #app-container {
            width: 100%;
            max-width: 400px;
            background-color: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            margin-top: 50px;
        }
        .form-input {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-sizing: border-box;
        }
        .btn-primary {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background-color: #10b981; /* Emerald green */
            color: white;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #059669;
        }
        .error-message {
            color: #ef4444; /* Red */
            margin-top: 10px;
            text-align: center;
            padding: 8px;
            border: 1px solid #fecaca;
            background-color: #fef2f2;
            border-radius: 8px;
        }
        .success-message {
            color: #10b981; /* Green */
            margin-top: 10px;
            text-align: center;
            padding: 8px;
            border: 1px solid #d1fae5;
            background-color: #f0fdf4;
            border-radius: 8px;
        }
    </style>
</head>
<body>

    <div id="app-container">
        <h1 class="text-3xl font-bold text-center text-green-700 mb-6">Welcome to 6amMart</h1>
        <div id="content"></div>
    </div>

    <!-- Firebase Imports and Logic -->
    <script type="module">
        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase imports from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-lite.js";
        
        // Disable logging in production for cleaner console (optional)
        // setLogLevel('silent'); // Uncomment for production

        let app, auth, db;
        let userId = null;
        let isAuthReady = false;

        const contentDiv = document.getElementById('content');

        // --- Utility Functions ---

        /** Displays messages to the user. */
        function showMessage(text, type = 'error') {
            let messageDiv = document.getElementById('message-box');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = 'message-box';
                contentDiv.prepend(messageDiv);
            }
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.textContent = text;
        }

        /** Renders the Login Form */
        function renderLogin() {
            contentDiv.innerHTML = `
                <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">Log In</h2>
                <input type="email" id="login-email" placeholder="Email" class="form-input" required>
                <input type="password" id="login-password" placeholder="Password" class="form-input" required>
                <button id="login-btn" class="btn-primary">Log In</button>
                <p class="text-center text-sm mt-4 text-gray-600">
                    Need an account? <a href="#" id="show-signup" class="text-green-600 font-semibold hover:text-green-700">Sign Up</a>
                </p>
                <div id="message-box"></div>
            `;
            document.getElementById('show-signup').addEventListener('click', (e) => {
                e.preventDefault();
                renderSignup();
            });
            document.getElementById('login-btn').addEventListener('click', handleLogin);
        }

        /** Renders the Signup Form */
        function renderSignup() {
            contentDiv.innerHTML = `
                <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">Sign Up</h2>
                <input type="email" id="signup-email" placeholder="Email" class="form-input" required>
                <input type="password" id="signup-password" placeholder="Password (min 6 characters)" class="form-input" required>
                <button id="signup-btn" class="btn-primary">Create Account</button>
                <p class="text-center text-sm mt-4 text-gray-600">
                    Already have an account? <a href="#" id="show-login" class="text-green-600 font-semibold hover:text-green-700">Log In</a>
                </p>
                <div id="message-box"></div>
            `;
            document.getElementById('show-login').addEventListener('click', (e) => {
                e.preventDefault();
                renderLogin();
            });
            document.getElementById('signup-btn').addEventListener('click', handleSignup);
        }

        /** Renders the Home Screen (After Successful Auth) */
        function renderHome() {
            contentDiv.innerHTML = `
                <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center">Welcome, User!</h2>
                <p class="text-center text-gray-600 mb-6">User ID: <span class="font-mono text-sm text-green-700 break-words">${userId || 'N/A'}</span></p>
                <div id="home-data" class="text-center text-gray-500">
                    <!-- Placeholder for fetching user-specific data -->
                    Data loaded successfully! You are signed in.
                </div>
                <button id="logout-btn" class="btn-primary bg-red-500 hover:bg-red-600">Log Out</button>
                <div id="message-box"></div>
            `;
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
        }

        // --- Authentication Handlers ---

        async function handleSignup() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            showMessage('Signing up...', 'success');

            try {
                // Ensure auth object is available
                if (!auth) throw new Error("Firebase Auth service is not initialized.");

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                showMessage(`Account created for ${user.email}!`, 'success');
                // The onAuthStateChanged listener will handle rendering the Home screen
            } catch (error) {
                console.error("Signup failed:", error);
                showMessage(error.message || "Sign up failed. Please try again.", 'error');
            }
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            showMessage('Logging in...', 'success');

            try {
                if (!auth) throw new Error("Firebase Auth service is not initialized.");

                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                showMessage(`Welcome back, ${user.email}!`, 'success');
                // The onAuthStateChanged listener will handle rendering the Home screen
            } catch (error) {
                console.error("Login failed:", error);
                showMessage(error.message || "Login failed. Please check your credentials.", 'error');
            }
        }

        async function handleLogout() {
            try {
                if (!auth) throw new Error("Firebase Auth service is not initialized.");
                await signOut(auth);
            } catch (error) {
                console.error("Logout error:", error);
                showMessage("Logout failed.", 'error');
            }
        }

        // --- Core Initialization ---

        /** Initializes Firebase services and authentication state listener. */
        function initializeFirebase() {
            if (!firebaseConfig) {
                showMessage("CRITICAL ERROR: Firebase configuration globals missing. Please ensure '__firebase_config' is set correctly in your environment variables.", 'error');
                console.error("CRITICAL ERROR: __firebase_config is missing or invalid.");
                return;
            }

            try {
                // 1. Initialize App
                app = initializeApp(firebaseConfig);
                
                // 2. Initialize Auth and Firestore
                auth = getAuth(app);
                db = getFirestore(app);
                
                // 3. Handle initial authentication
                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken)
                        .then(() => console.log("Signed in with custom token."))
                        .catch(err => {
                            console.error("Custom token sign-in failed:", err);
                            // Fallback to anonymous sign-in if custom token fails
                            signInAnonymously(auth).catch(anonErr => console.error("Anonymous sign-in failed:", anonErr));
                        });
                } else {
                    // If no initial token, sign in anonymously for initial setup/database access
                    signInAnonymously(auth)
                        .then(() => console.log("Signed in anonymously."))
                        .catch(err => console.error("Anonymous sign-in failed:", err));
                }

                // 4. Set up Auth State Listener
                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true; // Auth check has completed
                    if (user) {
                        userId = user.uid;
                        // User is signed in (either anonymously or via email/password)
                        console.log("Auth State Changed: User is logged in.", userId);
                        renderHome();
                    } else {
                        userId = null;
                        // User is signed out, show login/signup
                        console.log("Auth State Changed: User is signed out.");
                        renderLogin();
                    }
                });

            } catch (e) {
                console.error("CRITICAL ERROR: Firebase Initialization Failed.", e);
                // Display the specific initialization error to the user
                showMessage("CRITICAL ERROR: App Initialization Failed. Check your console for details, likely due to an invalid configuration key format or missing services. Error: " + e.message, 'error');
                
                // Fallback to show login/signup structure even if services failed
                renderLogin(); 
            }
        }

        // Run the main initialization logic when the page loads
        initializeFirebase();
    </script>
    
</body>
</html>
